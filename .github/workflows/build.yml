name: Build Android APK
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install Ninja & Python
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build python3-pip

      - name: Setup NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r26b

      # ğŸŸ¢ å…³é”®ä¿®æ”¹ï¼šå½»åº•æ¸…æ´— SDK ç¯å¢ƒ
      - name: Fix Android SDK
        run: |
          echo "æ­£åœ¨æ¸…ç†é¢„è£…çš„ Android SDK..."
          # 1. åˆ æ‰æ‰€æœ‰ç°æœ‰çš„å¹³å° (é˜²æ­¢ Qt è¯¯é€‰ Android 36)
          sudo rm -rf $ANDROID_HOME/platforms
          sudo rm -rf $ANDROID_HOME/build-tools
          
          # 2. é‡æ–°å»ºç«‹ç©ºç›®å½•
          sudo mkdir -p $ANDROID_HOME/platforms
          sudo mkdir -p $ANDROID_HOME/build-tools
          
          # 3. é‡æ–°å®‰è£…ä¸”ä»…å®‰è£… Android 33
          echo "æ­£åœ¨å®‰è£… Android 33..."
          SDK_MANAGER=$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager
          echo "y" | sudo $SDK_MANAGER --licenses > /dev/null
          sudo $SDK_MANAGER "platforms;android-33" "build-tools;33.0.2" "platform-tools"

      - name: Install Qt Manually
        run: |
          pip install aqtinstall
          # ä¸‹è½½ Qt 6.5.0 (å…¼å®¹æ€§æœ€å¥½)
          python3 -m aqt install-qt linux desktop 6.5.0 gcc_64 --outputdir my_qt
          python3 -m aqt install-qt linux android 6.5.0 android_arm64_v8a --outputdir my_qt

      - name: Build APK
        run: |
          mkdir build
          cd build
          
          # è·¯å¾„å®šä¹‰
          PWD=$(pwd)
          MY_QT_ROOT=$PWD/../my_qt/6.5.0
          QT_HOST_PATH=$MY_QT_ROOT/gcc_64
          ANDROID_QT_PATH=$MY_QT_ROOT/android_arm64_v8a
          
          # æ£€æŸ¥ Qt æ˜¯å¦ä¸‹è½½æˆåŠŸ
          ls $ANDROID_QT_PATH/bin/qt-cmake || exit 1

          # === ç¼–è¯‘é…ç½® ===
          cmake .. \
            -GNinja \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_QT_PATH/lib/cmake/Qt6/qt.toolchain.cmake \
            -DANDROID_NDK_ROOT=${{ steps.setup-ndk.outputs.ndk-path }} \
            -DQT_HOST_PATH=$QT_HOST_PATH \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-33 \
            -DANDROID_SDK_ROOT=$ANDROID_HOME \
            -Wno-dev

          # ç¼–è¯‘ C++ åº“
          cmake --build . --parallel
          
          # === æ‰“åŒ…é˜¶æ®µ ===
          # CMake çš„è‡ªåŠ¨æ‰“åŒ…åˆšæ‰å¤±è´¥äº†ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä¹ŸåŠ ä¸Šå¼ºåˆ¶æŒ‡å®š SDK çš„å‚æ•°
          # ç¡®ä¿ç¯å¢ƒå˜é‡æŒ‡å‘æ­£ç¡®çš„ Java
          export JAVA_HOME=$JAVA_HOME_17_X64
          
          echo "å¼€å§‹æ‰“åŒ… APK..."
          $QT_HOST_PATH/bin/androiddeployqt \
            --input android-MySuperApp-deployment-settings.json \
            --output android-build \
            --android-platform android-33 \
            --jdk $JAVA_HOME \
            --gradle \
            --verbose

          # æŸ¥æ‰¾ APK
          find . -name "*.apk" -exec cp {} ../app-release.apk \;

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: My-App
          path: app-release.apk
